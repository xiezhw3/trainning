# 单元测试
[TOC]

## 简介
stage5 的任务是完成 server 所有模块的单元测试。并且要达到较高的覆盖率。我是按照组内新推的单测规范进行写的。目前的覆盖率为 99%，有一行未覆盖到的是将 `__main__` 作为模块跑的时候 `if __name__ == '__main__'` 下面的执行语句，目前不知道怎么测。还有一个测试完成的不好的是测试 `__main__` 模块的 `register_site` 方法的时候，还不清楚怎么去测注册好的 app，使其可以访问。这两处地方后面需要加以改进。

项目的测试方法已经写在 `agent-server` 目录下的 `README` 文件的 `测试`部分。需要测试请直接按照说明执行对应测试脚本。

## 问题
写单测是一个比较费时的工作，因为需要覆盖到每一个方法。并且在一些情况下很难构造测试的条件。比如需要一个 flask app 运行环境、moogo 环境、rabbitmq 环境等。这些都需要自己去构造。目前测试代码里面有一些地方比如 rabbitmq 模块的测试可能不够完善，就是因为构建测试环境不好把握。在这方面也需要逐渐改进。

## 总结
因为以前没有好好理解单测，所以在做通知系统的时候写的单测不像单测。在写单测的时候测主要难度就是在构建模块执行环境上。这部分的代码可能就占了整个测试代码的大部分。经过这次写单测，让我在处理整个项目各个部分的测试环境测处理上有了一定的理解。因为在构建测试环境的时候通常需要考虑模块之间的关系，让我对模块之间的关系有人有了更深的理解。然后发现其实在离职前写的通知系统 shorturl 的单测其实也是不太合适的。它的依赖不应该用实际环境的短链接服务而是应该自己进行构建。避免对其他模块产生依赖。

总的来说，基本上了解了些单测需要注意的问题。在处理些单测中遇到的问题方面也有了一定的方向。

最后，感谢教主的悉心指导，基本上是在教主的指导下入门的。

## Contact

e-mail：xiezhw3@163.com
