# 多机agent
[TOC]

## 简介
stage3 的任务是将 stage2 的单机监控系统扩展到多机环境。后台机器监控部分的代码没有太大变化，就是加入了一个机器 ip 的字段。中间的数据传输中我用了 rabbitmq 作为中间件实现数据提交和处理的分离。关于系统本身的详细介绍在 training 下的 README 可以看到。

目前系统主要由 docker-compose 来进行启停，所以如果要直接部署在物理机的话需要先修改配置文件里的 mongo 和 api 的地址。

## 遇到的问题
### 前端部分的重构
因为 stage2 部分刚开始接触前端，当时采用的图表插件也不那么理想，导致数据量较多的时候系统响应很慢。所以直接对整个前端进行重构。也用 highchart 替换了原来的 chart.js，但是写完了才发现 highchart-ng 的一个坑，它在刷新出页面的时候偶尔会出现将所有数据点都标示出来的情况。这个问题目前还没有解决。

另外，因为目前是每次刷新都直接重新加载时间范围内的所有数据，所以一次加载长时间的数据的话会造成页面的卡顿。这也是可以优化的地方。

## 总结
多机 Agent 的后台不算复杂，还是能够在较短的时间完成。只是在处理 rabbitmq 的时候在数据传输中出现了点问题。但是前端部分是一个比较大的坑，包括在请求处理的时候返回对象还是数组的问题、父子控制器之间变向共享问题，插件回调问题等。在 satge2 中，没有仔细看 datetimepicker 插件的文档，没有使用它的回调函数机制，而是直接 $watch 变量，增加了处理的复杂性。在 stage3 中文哦注意了处理这类的问题，使得代码逻辑更为简单。

因为有了 stage2 的踩坑经验，stage3 完成的还算比较顺利。没有遇到花费很长时间的问题。经过 stage2 和 stage3 的任务，自己对前端的知识掌握也更多。加上这段时间在值班系统上的工作，已经慢慢开始入门前端了。以后也会花较大部分的时间学习前端，让自己在这个方面知识面的广度和深度都有较大提高。

## 说明
另外要说明的是，我的整个系统都是在 docker 的环境下进行开发的，所以没有直接在物理机上进行部署测试。需要进行测试的时候可以直接在 compose 文件里面增加 server，目前我的 compose 文件提供了两台 server。可以通过 `scripts/docker-run.sh` 来启停某个模块，但对应的模块要已经在 conpose 文件里面定义。


## Contact

E-mail: xiezhw3@163.com
