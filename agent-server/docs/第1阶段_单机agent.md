# 单机agent
[TOC]

## 简介
stage1 的任务是设计完成一个单机监控系统。我的数据的采集采用 psutil 工具和 python 的 sys 库来实现。所以在数据采集方面代码量不多。因为审题不仔细的原因，做了部分 stage2 的任务。关于系统的介绍请看根目录下的 README.md，下面主要说一下我再完成系统时遇到的问题。

## 遇到的问题
### 数据采集
在数据采集方面因为是使用 psutil 的原因，基本没有遇到太多的问题。在这个过程中对不熟悉的东西比如负载进行了详细了解。对一个监控系统要做哪些工作有了较多的了解。

### 数据存储
数据存储采用 mongodb 实现，也没有遇到什么问题。

### api
在 api 部分遇到了比较大的问题，因为我的项目结构是将 main 文件当成一个模块来运行，而 flask 在使用 debug 模式的时候会以其运行文件所在目录进行重启，这样就是的我的代码在 import 的时候出现路径错误。这个错误的处理花了我非常多的时间。而在这种情况下也基本无法进行调试。最后在朋友的帮助下发现在这种情况下不能设置为 debug 模式，只能直接运行。

### docker 容器构建
这部分是踩坑最多的部分。一个方面是在构建 Dockerfile 的时候，另一个方面是在构建 docker-compose 的时候。一开始在使用 pip 安装 python 库的时候一直不成功，尝试了换 pip 源，换 debain 源等一系列操作后，最终发现是需要先安装 python-dev 包。于是最终解决了问题。
另一个问题是在构建 docker-compose 的时候，因为涉及到 mongo 容器和 server，api 容器之间的联系，另外涉及到文件目录的问题，所以出现了较多的锅。因为导师提供的 Dockerfile 对应的项目目录和我的不一样，所以一开始运行不成功，后面才发现是目录问题。另外关于 mongo 启动慢于 server 导致 docker 第一次启动不成功的问题，我还没有找到好的解决方法，只能通过重启 server 服务来解决。

## 总结
这个阶段的任务实际上来说并不难，因为没有涉及到太多的东西。只是因为对 docker 不熟悉可能会出现构建 docker 的问题。总的来说对自己有两个方面的提升，一个是对监控系统的了解，另一个就是 docker 容器的构建以及 docker-compose 的使用。因为在这个过程中踩了比较多坑所以还是花了比较多的时间。

## Contact
E-mail： xiezhw3@163.com

